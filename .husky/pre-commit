#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Verificar se hÃ¡ arquivos staged
if git diff --cached --quiet; then
    echo "âŒ No files staged for commit"
    exit 1
fi

# Validar arquivos HTML
echo "ğŸ“ Validating HTML files..."
for file in $(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(html)$'); do
    if [ -f "$file" ]; then
        # Verificar se hÃ¡ tags HTML bÃ¡sicas
        if ! grep -q "<html" "$file"; then
            echo "âŒ Error: $file doesn't appear to be a valid HTML file"
            exit 1
        fi
        echo "âœ… $file is valid"
    fi
done

# Validar arquivos Markdown
echo "ğŸ“ Validating Markdown files..."
for file in $(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(md)$'); do
    if [ -f "$file" ]; then
        # Verificar se o arquivo nÃ£o estÃ¡ vazio
        if [ ! -s "$file" ]; then
            echo "âŒ Error: $file is empty"
            exit 1
        fi
        echo "âœ… $file is valid"
    fi
done

# Validar arquivos Shell Script
echo "ğŸ“ Validating shell scripts..."
for file in $(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(sh)$'); do
    if [ -f "$file" ]; then
        # Verificar shebang
        if ! head -n 1 "$file" | grep -q '^#!'; then
            echo "âš ï¸  Warning: $file missing shebang"
        fi
        
        # Verificar sintaxe com shellcheck se disponÃ­vel
        if command -v shellcheck &> /dev/null; then
            if ! shellcheck "$file"; then
                echo "âŒ Error: $file has shellcheck errors"
                exit 1
            fi
        fi
        echo "âœ… $file is valid"
    fi
done

# Verificar se hÃ¡ conflitos de merge nÃ£o resolvidos
echo "ğŸ” Checking for merge conflicts..."
if git diff --cached --check; then
    echo "âœ… No merge conflicts found"
else
    echo "âŒ Error: Merge conflicts detected"
    exit 1
fi

# Verificar tamanho de arquivos (limitar a 1MB)
echo "ğŸ“Š Checking file sizes..."
for file in $(git diff --cached --name-only --diff-filter=ACM); do
    if [ -f "$file" ]; then
        size=$(wc -c < "$file")
        if [ "$size" -gt 1048576 ]; then
            echo "âŒ Error: $file is larger than 1MB ($size bytes)"
            exit 1
        fi
    fi
done

echo "âœ… All pre-commit checks passed!"
echo "ğŸ“¦ Ready to commit"
